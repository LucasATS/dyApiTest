<!DOCTYPE html>

<head>
    <html lang="pt-br">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dyAPI Test</title>

    <!-- LOCAL -->
    <link rel="icon" type="image/x-icon" href="imgs/icon.png">
    <link rel="stylesheet" href="css/index.css">
    <script src="js/formatadorJSON.js"></script>
    <script src="js/sistemaLinks.js"></script>
    <script src="js/statusCode.js"></script>
    <script src="js/modals.js"></script>
    <script src="js/index.js"></script>

    <!-- REACT UNPKG -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- OUTROS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/jsoneditor.min.js"></script>

</head>

<body class="col center">
    <header class="center"
        style="display: flex; flex-direction: row; align-self: center; align-items: center; width: 200px; column-gap: 15px;">
        <img src="imgs/icon.png" width="24px" height="24px" />
        <h1 style="font-style: italic; font-weight: 24px;">dyAPITest</h1>
    </header>

    <section>
        <div id="root"></div>
    </section>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App(props) {
            const [url, setUrl] = useState(null);
            const [method, setMethod] = useState('GET');
            const [headers, setHeaders] = useState('{ "Content-Type": "application/json" }');
            const [mode, setMode] = useState(null);
            const [body, setBody] = useState(null);

            const [consoleLog, setConsoleLog] = useState(null);
            const [codigo, setCodigo] = useState(null);

            const [statusCode, setStatusCode] = useState(0);

            useEffect(() => {
                let dadosDoLink = lerLink();

                try {
                    if (dadosDoLink !== null) {
                        setMethod(dadosDoLink?.method);
                        setHeaders(JSON.stringify(JSON.parse(dadosDoLink?.headers), null, 2) || dadosDoLink?.headers);
                        setMode(dadosDoLink?.mode);
                        setUrl(dadosDoLink?.url);
                        setBody(JSON.stringify(JSON.parse(dadosDoLink?.body), null, 2) || dadosDoLink?.body);

                        setStatusCode(dadosDoLink?.statusCode);
                        setConsoleLog(JSON.stringify(JSON.parse(dadosDoLink?.consoleLog), null, 2) || dadosDoLink?.consoleLog);

                        dadosDoLink = null;
                    }
                } catch (error) {
                    console.log(error);
                }
            }, []);

            const handleInputChange = (event) => {
                const { name, value } = event.target;

                switch (name) {
                    case 'url':
                        setUrl(value);
                        break;
                    case 'method':
                        setMethod(value);
                        break;
                    case 'headers':
                        setHeaders(value);
                        break;
                    case 'mode':
                        setMode(value);
                        break;
                    case 'body':
                        setBody(value);
                        break;
                    default:
                        break;
                }
            };

            const handleSubmit = async (event) => {
                if (url !== '' && url !== null) {
                    const dados = {
                        url: url,
                        method: method, headers: headers,
                        mode: mode, body: body,
                    }
                    console.log(dados);
                    const log = await submit(dados);

                    setStatusCode(log?.status);

                    const text = await log?.text()
                    try {
                        setConsoleLog(JSON.stringify(JSON.parse(text), null, 2));
                    } catch (error) {
                        setConsoleLog(text);
                    }
                } else {
                    modalErro(mensagens.erroSemURL)
                }
            };

            const handleCompartilhar = async () => {
                if (url !== '' && url !== null) {
                    const dados = {
                        url: url,
                        method: method,
                        headers: JSON.stringify(JSON.parse(headers)),
                        mode: mode,
                        body: JSON.stringify(JSON.parse(body)),
                        consoleLog: JSON.stringify(JSON.parse(consoleLog)),
                        statusCode: statusCode,
                    }
                    gerarLink(dados);
                } else {
                    modalErro(mensagens.erroSemURL)
                }
            }

            return (
                <div className="row center" style={{ gap: 15 + 'px' }}>
                    <form className="col center" style={{ gap: 15 + 'px' }}>
                        <span className="row" style={{ gap: 10 + 'px' }}>
                            <select className="" value={method} name="method" onChange={handleInputChange}>
                                <option>GET</option>
                                <option>POST</option>
                                <option>PUT</option>
                                <option>DELETE</option>
                                {/* <option>OPTIONS</option> */}
                                {/* <option>HEAD</option> */}
                            </select>
                            <input className="" placeholder="URL" type="text" name="url" value={url} onChange={handleInputChange} />
                        </span>


                        <input className="" placeholder="mode" type="text" name="mode" value={mode} style={{ width: 450 + 'px' }} onChange={handleInputChange} />


                        <span className="col" style={{ gap: 10 + 'px' }}>
                            {/* <input type="text" className="" placeholder="headers" style={{ width: 450 + 'px' }} value={headers} name="headers" readonly /> */}
                            <textarea className="" placeholder="headers" value={headers} name="headers" onChange={handleInputChange}
                                onBlur={() => { setHeaders(JSON.stringify(formatarJson(headers), null, 2)) }} />
                            <textarea className="" placeholder="body" value={body} name="body" onChange={handleInputChange}
                                onBlur={() => { setBody(JSON.stringify(formatarJson(body), null, 2)) }} />
                        </span>


                        <span className="row" style={{ justifyContent: 'space-between', gap: 10 + 'px' }}>
                            <button type="button" onClick={handleCompartilhar} className={"animation botao"}>Compartilhar</button>
                            <button type="button" onClick={handleSubmit} className={"animation botao"}>submit</button>
                        </span>
                    </form>


                    <span className="col" style={{ gap: 10 + 'px' }}>
                        {statusCode !== 0 &&
                            <p className={`status_${statusCodeParaTexto(statusCode)?.ok}`}>{statusCode} {statusCodeParaTexto(statusCode)?.msg}</p>
                        }
                        {/* <textarea className="" value={codigo} readonly /> */}
                        <textarea className="" placeholder="Console:" value={consoleLog} readonly
                            onBlur={() => { setConsoleLog(JSON.stringify(JSON.parse(consoleLog), null, 2) || consoleLog) }} />
                    </span>


                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>

    <BotaoVisitaGithub model="modelo3" link="https://github.com/LucasATS/dyApiTest"></BotaoVisitaGithub>
    <script
        src="https://cdn.jsdelivr.net/gh/LucasATS/BotaoVisitaGithub@5543a67f6227cb9bdb380625b51983b56a10c9ba/BotaoVisitaGithub.js"></script>

    <footer>
        <p onclick="window.location.href = './sobre.html'" class="version"> 20230722-2v</p>
    </footer>
</body>

</html>